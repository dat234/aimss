<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIMS </title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>AIMS </h1>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." class="search-input">
      <button onclick="searchProducts()" class="search-btn">
        <span class="search-icon">üîç</span>
        T√¨m ki·∫øm
      </button>
      <button onclick="clearSearch()" class="clear-search-btn" id="clearSearchBtn" style="display: none;">
        <span class="clear-icon">‚úï</span>
        X√≥a t√¨m ki·∫øm
      </button>
    </div>
    <div class="auth-buttons" id="authButtons">
      <button onclick="location.href='login.html'">ƒêƒÉng nh·∫≠p</button>
      <button onclick="location.href='register.html'">ƒêƒÉng k√Ω</button>
    </div>
    <div class="user-info hidden" id="userInfo">
      <button class="user-name-btn" id="userNameBtn" onclick="showUserProfile()">
        <span id="userName">T√™n ng∆∞·ªùi d√πng</span>
      </button>
      <button class="btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>
  </header>

  <main>
    <div class="search-results" id="searchResults" style="display: none;">
      <h3>K·∫øt qu·∫£ t√¨m ki·∫øm cho: "<span id="searchTerm"></span>"</h3>
      <p>T√¨m th·∫•y <span id="resultCount">0</span> s·∫£n ph·∫©m</p>
    </div>
    <div class="product-grid" id="productGrid">
      <!-- S·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c render t·ª´ JS -->
    </div>
  </main>

  <!-- User Profile Modal -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Th√¥ng tin ng∆∞·ªùi d√πng</h2>
        <span class="close" onclick="closeUserModal()">&times;</span>
      </div>
      <div id="userModalContent">
        <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load t·ª´ JS -->
      </div>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script>
    let currentSearchTerm = '';
    let isSearching = false;

    // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p v√† load s·∫£n ph·∫©m khi trang load
    document.addEventListener("DOMContentLoaded", async () => {
      await checkAuthStatus();
      await loadProducts();
      
      // Th√™m event listener cho Enter key trong search input
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchProducts();
        }
      });
    });

    // ƒê√≥ng modal
    function closeUserModal() {
      const modal = document.getElementById('userModal');
      modal.style.display = 'none';
    }

    // ƒê√≥ng modal khi click b√™n ngo√†i
    window.onclick = function(event) {
      const modal = document.getElementById('userModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    }

    // T√¨m ki·∫øm s·∫£n ph·∫©m
    async function searchProducts() {
      const searchInput = document.getElementById('searchInput');
      const searchTerm = searchInput.value.trim();
      
      if (!searchTerm) {
        alert('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm!');
        return;
      }

      currentSearchTerm = searchTerm;
      isSearching = true;
      
      try {
        const res = await fetch(`http://localhost:8000/v1/products/search?title=${encodeURIComponent(searchTerm)}`);
        const data = await res.json();
        
        if (data.success) {
          displaySearchResults(data.result, searchTerm);
        } else {
          alert('C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm!');
        }
      } catch (err) {
        console.error('L·ªói t√¨m ki·∫øm:', err);
        alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!');
      }
    }

    // Hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm
    function displaySearchResults(products, searchTerm) {
      const grid = document.getElementById("productGrid");
      const searchResults = document.getElementById("searchResults");
      const searchTermSpan = document.getElementById("searchTerm");
      const resultCount = document.getElementById("resultCount");
      const clearSearchBtn = document.getElementById("clearSearchBtn");

      // Hi·ªÉn th·ªã th√¥ng tin t√¨m ki·∫øm
      searchResults.style.display = 'block';
      searchTermSpan.textContent = searchTerm;
      resultCount.textContent = products.length;
      clearSearchBtn.style.display = 'inline-block';

      // Render s·∫£n ph·∫©m
      grid.innerHTML = "";
      
      if (products.length === 0) {
        grid.innerHTML = `
          <div class="no-results">
            <p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o ph√π h·ª£p v·ªõi t·ª´ kh√≥a "${searchTerm}"</p>
            <button onclick="clearSearch()" class="btn-primary">Quay l·∫°i t·∫•t c·∫£ s·∫£n ph·∫©m</button>
          </div>
        `;
        return;
      }

      products.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card";
        card.setAttribute('data-product-id', p._id);
        card.innerHTML = `
          <div class="product-image-container">
            <img src="${p.thumbnail || 'https://via.placeholder.com/200x180'}" alt="Product">
            <div class="product-overlay">
              <div class="product-stock-badge ${p.stock > 0 ? 'in-stock' : 'out-of-stock'}">
                ${p.stock > 0 ? 'C√≤n h√†ng' : 'H·∫øt h√†ng'}
              </div>
            </div>
          </div>
          <div class="product-info">
            <h3 class="product-title">${p.title}</h3>
            <div class="product-price">${p.price.toLocaleString()} USD</div>
            <div class="product-description">${p.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</div>
            <div class="product-stock-info">
              <span class="stock-label">T·ªìn kho:</span>
              <span class="stock-value ${p.stock > 10 ? 'high' : p.stock > 0 ? 'medium' : 'low'}">${p.stock} s·∫£n ph·∫©m</span>
            </div>
          </div>
          <div class="product-actions">
            <button class="btn-detail" onclick="viewProductDetail('${p._id}')">
              <span class="btn-icon">üëÅÔ∏è</span>
              Xem chi ti·∫øt
            </button>
            ${window.authManager && window.authManager.isCustomer() ? 
              `<button class="btn-cart" onclick="addToCartDirect('${p._id}')" ${p.stock <= 0 ? 'disabled' : ''}>
                <span class="btn-icon">üõí</span>
                ${p.stock > 0 ? 'Th√™m v√†o gi·ªè' : 'H·∫øt h√†ng'}
              </button>` : 
              ''
            }
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // X√≥a t√¨m ki·∫øm v√† quay l·∫°i t·∫•t c·∫£ s·∫£n ph·∫©m
    async function clearSearch() {
      const searchInput = document.getElementById('searchInput');
      const searchResults = document.getElementById("searchResults");
      const clearSearchBtn = document.getElementById("clearSearchBtn");

      searchInput.value = '';
      searchResults.style.display = 'none';
      clearSearchBtn.style.display = 'none';
      
      currentSearchTerm = '';
      isSearching = false;
      
      await loadProducts();
    }

    // Load s·∫£n ph·∫©m
    async function loadProducts() {
      const grid = document.getElementById("productGrid");
      try {
        const res = await fetch("http://localhost:8000/v1/products?current=1&pageSize=10");
        const data = await res.json();
        const products = data.result;
        grid.innerHTML = "";

        products.forEach(p => {
          const card = document.createElement("div");
          card.className = "product-card";
          card.setAttribute('data-product-id', p._id);
          card.innerHTML = `
            <div class="product-image-container">
              <img src="${p.thumbnail || 'https://via.placeholder.com/200x180'}" alt="Product">
              <div class="product-overlay">
                <div class="product-stock-badge ${p.stock > 0 ? 'in-stock' : 'out-of-stock'}">
                  ${p.stock > 0 ? 'C√≤n h√†ng' : 'H·∫øt h√†ng'}
                </div>
              </div>
            </div>
            <div class="product-info">
              <h3 class="product-title">${p.title}</h3>
              <div class="product-price">${p.price.toLocaleString()} USD</div>
              <div class="product-description">${p.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</div>
              <div class="product-stock-info">
                <span class="stock-label">T·ªìn kho:</span>
                <span class="stock-value ${p.stock > 10 ? 'high' : p.stock > 0 ? 'medium' : 'low'}">${p.stock} s·∫£n ph·∫©m</span>
              </div>
            </div>
            <div class="product-actions">
              <button class="btn-detail" onclick="viewProductDetail('${p._id}')">
                <span class="btn-icon">üëÅÔ∏è</span>
                Xem chi ti·∫øt
              </button>
              ${window.authManager && window.authManager.isCustomer() ? 
                `<button class="btn-cart" onclick="addToCartDirect('${p._id}')" ${p.stock <= 0 ? 'disabled' : ''}>
                  <span class="btn-icon">üõí</span>
                  ${p.stock > 0 ? 'Th√™m v√†o gi·ªè' : 'H·∫øt h√†ng'}
                </button>` : 
                ''
              }
            </div>
          `;
          grid.appendChild(card);
        });
      } catch (err) {
        grid.innerHTML = '<p style="text-align:center;color:red">Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m.</p>';
        console.error(err);
      }
    }

    // Function ƒë·ªÉ th√™m v√†o gi·ªè h√†ng tr·ª±c ti·∫øp (kh√¥ng qua modal)
    window.addToCartDirect = async function(productId) {
      const quantity = prompt('Nh·∫≠p s·ªë l∆∞·ª£ng:', '1');
      if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
        const result = await window.authManager.addToCart(productId, parseInt(quantity));
        
        if (result.success) {
          alert('ƒê√£ th√™m v√†o gi·ªè h√†ng th√†nh c√¥ng!');
        } else {
          alert(`L·ªói: ${result.error}`);
        }
      } else if (quantity !== null) {
        alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá!');
      }
    };
  </script>
</body>
</html>
